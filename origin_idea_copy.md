# WisdomPrompt 产品与研发说明

**WisdomPrompt** 是一个完整网站，包含落地页/首页、介绍页、产品页、文档页等。  
**产品页**提供核心能力：联网搜索（exa / serper / brave）、知识库检索（DuckDB + vss 存储的提示词与 skills）、以及基于检索结果的提示词生成。

---

## 产品页工作流

1. 用户输入 query，中控（LLM+提示词）对 query 重写/润色/拆分，返回**子任务列表**（1～4 条，尽量 1～2 条；单条也以列表下发）。
FOR sub_task IN tasks:
  2. 用子任务关键词到**向量库**检索：取 **top3**，相似度 **≥0.7** 视为达标并下发；不足则联网搜索（见下），拉取正文后写入向量库并下发。所有内容须带**内容来源**。
  3. 将检索到的内容 + 子任务输入 Agent（LLM+提示词）**整理**。
END
4. 将所有整理结果 + 子任务名 + 用户原始 query 输入 Agent，生成**最终答案**（支持 Markdown；前端渲染 Markdown 并支持一键复制为 Markdown 格式）。

---

## 产品页技术模块

| 模块 | 说明 |
|------|------|
| 信息采集 | 联网搜索仅选一种，默认 **brave**，通过 **SEARCH_SOURCE** 可改为 exa / serper / brave；检索若仅标题与链接则拉取正文（见下） |
| Agent（元提示词） | 三套提示词存于 **prompts** 文件夹：query 拆解与任务规划、子任务整理与筛选融合、信息汇总生成最终答案 |
| 向量存储 | DuckDB + **duckdb-vss**；Embedding 维度与向量模型一致；**异步写入**、**去重**（如按 URL） |

**信息采集·正文拉取**  
- 联网搜索有时只返回标题和链接。先调用 **webfetch**；失败则**延时重试**，重试仍失败则用 **Jina Reader**（仍计入 Jina 限流）。  
- **Jina Reader**：提供开关（是否启用）；限流 **10 次/日、10000 token/日**。  
- 搜索 API、Jina 等配置均从 **.env** 读取。

---

## 网站技术栈

（全站共用；产品页能力依赖后端向量库与 LLM/Embedding。）

| 端 | 技术 |
|----|------|
| 前端 | Vite、React、Tailwind CSS、shadcn/ui |
| 后端 | FastAPI、Python；DuckDB + vss |
| LLM | OpenAI |
| Embedding | Gemini |

---

## 产品页交互过程（实时动态、类标准 AI 应用）

- **整体原则**：全流程流式、实时更新；任一步骤可修改，**从该步及后续重跑**（复用前面结果），非全量重跑。
- **第一步（Query 拆解）**：加载态 → 展示子任务列表，支持确认或编辑后再执行。
- **第二步（检索/联网）**：每个子任务用**折叠卡片**：进行中展开+加载态；完成后展示结果与来源（可跳转链接），**可配置**的自动收起时间（如 2s）后收起，进入下一步。
- **第三步（子任务整理）**：在检索卡片内以子卡片实时展示汇总/整理结果，可折叠。
- **第四步（最终答案）**：流式展示；**支持 Markdown 渲染**，并提供**一键复制为 Markdown**。
- **接口**：产品页与后端流式通信使用 **SSE**；基础 URL 等约定在 **.env** 中配置。

---

## 开发分工与要求

### 前端开发

- **技术栈**：React、Tailwind CSS、Vite、shadcn/ui。
- **基础能力**：页面配色、布局、美观；可参考 ui-ux-pro skills；保持落地页、介绍页、产品页、文档页风格一致。
- **页面区分**：介绍页为品牌/功能说明（静态或轻交互）；**产品页**为上述工作流（联网搜索、知识库检索、提示词生成）及实时交互（流式、折叠卡片、加载态等）。
- **路由约定**：落地页 `/`、介绍页 `/about`、产品页 `/app`、文档页 `/docs`。  
- **文档页**：支持基于文件系统的 Markdown 渲染即可（如 Fumadocs 等，不限定具体方案）。

### 后端开发

- **技术栈**：FastAPI；DuckDB + vss；LLM/Embedding 接入。
- **配置**：大部分配置放 **.env**，其余可放 **config 文件**或其他配置文件（见「配置与约定汇总」）。
- **架构**：模块化、异步；API 设计清晰，配合 FastAPI 自动文档与交互支持。
- **工程**：结构化日志（Structured Logging），便于排查与联调。

### 前后端联调

- **后端**：自测与验证，通过加日志迭代验证行为。
- **联调方式**：Agent 使用 Browser 等能力进行前后端联调。

---

## 模型选型

- **LLM**：OpenAI，默认 **gpt-5-mini**（拆解/整理/汇总可共用），可在 **.env** 中配置模型 ID。
- **Embedding**：Gemini，模型 **text-embedding-001**，维度与模型一致。

---

## 配置与约定汇总

**配置存放约定**：大部分配置放在 **.env** 中（如 API Key、模型 ID、开关、限流、基础 URL 等）；其余配置可放在 **config 文件**或**其他配置文件**（如 YAML/JSON/TOML），按项目约定划分（如功能模块、环境区分等）。

- **.env**：SEARCH_SOURCE（exa / serper / brave，默认 brave）、Jina Reader 开关与限流相关、LLM 模型 ID、SSE/API 基础 URL 等。
- **config 或其他配置文件**：与 .env 互补，存放不适宜放入 .env 的配置（如复杂结构、多环境配置等）。
- **向量检索**：top3，相似度 ≥0.7；子任务 1～4 条，尽量 1～2 条。
- **Jina Reader**：10 次/日、10000 token/日；webfetch 失败先重试，再 fallback 到 Jina（计入限流）。
- **路由**：`/`、`/about`、`/app`、`/docs`。